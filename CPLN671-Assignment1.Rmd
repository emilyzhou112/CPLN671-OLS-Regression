---
title: "CPLN671-Assignment1"
author: "Emily Zhou"
date: "2024-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

options(scipen = 999)

# all the library loaded
library(tidyverse)
library(here)

```


```{r}

# simply read in data
data <- read_csv(here("data", "RegressionData.csv"))

```


```{r}

# 1. Using the hist, mean, and sd commands in R, examine the distribution of
# the dependent variable, MEDHVAL, and predictors PCBACHMORE,
# NBELPOV100, PCTVACANT, and PCTSINGLES, and calculate the mean and
# standard deviation of each of these variables.

variables <- c("MEDHVAL", "PCTBACHMOR", "NBELPOV100", "PCTVACANT", "PCTSINGLES")

for (var in variables) {
  # Histogram
  hist(data[[var]], main = paste("Histogram of", var), xlab = var, col = "grey", border = "black")
  
  # Mean and standard deviation
  mean_val <- mean(data[[var]], na.rm = TRUE)
  sd_val <- sd(data[[var]], na.rm = TRUE)
  
  cat(paste(var, "mean:", mean_val, "\n"))
  cat(paste(var, "standard deviation:", sd_val, "\n\n"))
}


```



```{r}

# alternaitve: better historgam using ggplot
# Load ggplot2
library(ggplot2)
library(reshape2)

# Reshape the dataframe to long format for easy facetting
data_long <- melt(data, measure.vars = c("MEDHVAL", "PCTBACHMOR", "NBELPOV100", "PCTVACANT", "PCTSINGLES"))


# Create scatterplots using facet_wrap
ggplot(data_long, aes(x = value)) +
  geom_histogram(aes(y = ..count..), fill = "skyblue", alpha = 0.7) +  
  facet_wrap(~variable, scales = "free", ncol = 3) +  
  labs(x = "Value", y = "Count", title = "Histograms with Custom Binning") +
  theme_minimal() +
  theme(panel.spacing = unit(2, "lines"))




```

```{r}

# 2. Use the log command to create 5 new variables called LNMEDHVAL, LNPCBACHMORE, LNNBELPOV100, LNPCTVACANT, and LNPCTSINGLES. 
data_logged<- data %>%
  mutate(
    LNMEDHVAL = if (min(MEDHVAL) == 0) log(1 + MEDHVAL) else log(MEDHVAL),
    LNPCTBACHMOR = if (min(PCTBACHMOR) == 0) log(1 + PCTBACHMOR) else log(PCTBACHMOR),
    LNNBELPOV100 = if (min(NBELPOV100) == 0) log(1 + NBELPOV100) else log(NBELPOV100),
    LNPCTVACANT = if (min(PCTVACANT) == 0) log(1 + PCTVACANT) else log(PCTVACANT),
    LNPCTSINGLES = if (min(PCTSINGLES) == 0) log(1 + PCTSINGLES) else log(PCTSINGLES)
  )


```


```{r}

# make histograms of the logged variables
data_logged_long <- melt(data_logged, measure.vars = c("LNMEDHVAL", "LNPCTBACHMOR", "LNNBELPOV100", "LNPCTVACANT", "LNPCTSINGLES"))

ggplot(data_logged_long, aes(x = value)) +
 geom_histogram(aes(y = ..count..), fill = "skyblue", alpha = 0.7) +  
  facet_wrap(~variable, scales = "free", ncol = 3) +  
  labs(x = "Value", y = "Count", title = "Histograms with Custom Binning") +
  theme_minimal() +
  theme(panel.spacing = unit(2, "lines"))

```


```{r}

# scatterplot
data_processed <- data_logged %>% 
  dplyr::select(c(POLY_ID, LNMEDHVAL, PCTBACHMOR, LNNBELPOV100, PCTVACANT, PCTSINGLES))
  
data_processed_long <- melt(data_processed, measure.vars = c("PCTBACHMOR", "LNNBELPOV100", "PCTVACANT", "PCTSINGLES"))

ggplot(data_processed_long, aes(x = value, y = LNMEDHVAL)) +
  geom_point(color = "steelblue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = FALSE) +  # Add a linear regression line
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Scatter Plots of Dependent Variable vs. Predictors", 
       x = "Predictor Value", 
       y = "Log of Median Value (LNMEDHVAL)")

```



```{r}

# explore multicolinearity using cor and correlation matrix

library(corrplot)
corr_data <-  data_processed %>% 
  dplyr::select(c(PCTBACHMOR, PCTVACANT, PCTSINGLES, LNNBELPOV100))
  

corrplot(cor(corr_data ), method = "number", type = "lower", tl.col = "black", tl.cex = 0.75, number.cex = 1)

```


```{r}

# import the shapefile and create choropleth maps of the following variables LNMEDHVAL 	PCTVACANT    	PCTSINGLES  PCTBACHMOR   LNNBELPOV100
library(sf)
philly <- st_read(here("data", "shapefile", "RegressionData.shp"))

```


```{r}

ggplot(philly) +
  geom_sf(aes(fill = LNMEDHVAL), color = NA) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Choropleth Map of LNMEDHVAL", fill = "Log Median Value") +
  theme_minimal()


```


```{r fig.height=8, fig.width=10}

library(patchwork)

map_pctvacant <- ggplot(philly) +
  geom_sf(aes(fill = PCTVACANT), color = NA) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "PCTVACANT", fill = "% Vacant") +
  theme_minimal()

map_pctsingles <- ggplot(philly) +
  geom_sf(aes(fill = PCTSINGLES), color = NA) +
  scale_fill_viridis_c(option = "magma") +
  labs(title = "PCTSINGLES", fill = "% Singles") +
  theme_minimal()

map_pcbachmore <- ggplot(philly) +
  geom_sf(aes(fill = PCTBACHMOR), color = NA) +
  scale_fill_viridis_c(option = "inferno") +
  labs(title = "PCTBACHMORE", fill = "% Bachelorâ€™s") +
  theme_minimal()

map_lnbelpov100 <- ggplot(philly) +
  geom_sf(aes(fill = LNNBELPOV), color = NA) +
  scale_fill_viridis_c(option = "cividis") +
  labs(title = "LNNBELPOV100", fill = "Log Poverty") +
  theme_minimal()

map_pctvacant + map_pctsingles + map_pcbachmore + map_lnbelpov100 + 
  plot_layout(ncol = 2)

```


```{r}

# use the lm command to run the regression where LNMEDHVAL is the dependent variable and PCTVACANT, PCTSINGLES, PCTBACHMOR, and LNNBELPOV100 are predictors

fit <- lm(LNMEDHVAL ~ PCTVACANT + PCTSINGLES + PCTBACHMOR + LNNBELPOV100, data=data_processed)
summary(fit)

```


```{r}


anova_table <- anova(fit)
anova_table

```

```{r}

error_sum_squares <- anova_table["Residuals", "Sum Sq"]
error_sum_squares

```



```{r}

# Use the fitted, residuals and rstandard commands to save the predicted values, residuals and standardized residuals, respectively. 

fitted_values <- fitted(fit)
residuals_values <- residuals(fit)
standardized_residuals <- rstandard(fit)

lm_data <- data_processed %>%
  mutate(
    Fitted = fitted_values,
    Residuals = residuals_values,
    Standardized_Residuals = standardized_residuals
  )

lm_data

```


```{r}

ggplot(lm_data, aes(x = Fitted, y = Standardized_Residuals)) +
  geom_point(color = 'blue', alpha = 0.6) +    # Scatter plot points
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +   # Add a horizontal line at y = 0
  labs(
    title = "Scatter Plot of Standardized Residuals vs Fitted Values",
    x = "Fitted Values",
    y = "Standardized Residuals"
  ) +
  theme_minimal() 


```



```{r}

library(MASS)
stepwise_model <-  stepAIC(fit, direction = "both")
stepwise_model

```

```{r}

stepwise_model$anova

```

```{r}
library(caret)
#rmse for full model
lm_1 = trainControl(method = "cv", number = 5)

cvlm_model = train(LNMEDHVAL ~ PCTVACANT + PCTSINGLES + PCTBACHMOR + LNNBELPOV100, data=data_processed, method = "lm", trControl = lm_1)

print(cvlm_model)

```

```{r}

cvlm_model_reduced = train(LNMEDHVAL ~ PCTVACANT + MEDHHINC, data = data_logged, method = "lm", trControl = lm_1)

print(cvlm_model_reduced)
```


```{r}

ggplot(lm_data, aes(x = Standardized_Residuals)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Standardized Residuals", 
       x = "Standardized Residuals", 
       y = "Frequency") +
  theme_minimal()




```



```{r}

lm_data <- philly %>%
  left_join(lm_data %>% dplyr::select(c(POLY_ID, Standardized_Residuals)), by = "POLY_ID") 

ggplot(lm_data) +
  geom_sf(aes(fill = Standardized_Residuals)) +  # Use geom_sf to map the polygons
  scale_fill_viridis_c(option = "C", direction = -1) +  # Choose a color palette, invert direction if needed
  theme_minimal() +  # Clean map style
  labs(
    title = "Choropleth Map of Standardized Residuals",
    fill = "Std Residuals"
  ) +
  theme(
    legend.position = "right",  # Position the legend
    plot.title = element_text(hjust = 0.5, size = 16)  # Center title
  )



```

